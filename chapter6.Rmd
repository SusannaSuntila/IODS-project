
# Aanalysis of longitudinal data


## Meet and repeat part I


### load in the data and draw a plot of the groups


```{r}
# Read in the data set that was created
# Read the RATSL data
RATSL <- read.table(file.path(".", "data", "RATSL.txt"))

# Look at the (column) names of RATSL
names(RATSL)

# Look at the structure of RATSL
str(RATSL) # ID and Group aren't factors anymore

# change ID and Groups back to factors
RATSL$ID <- factor(RATSL$ID)
RATSL$Group <- factor(RATSL$Group)

str(RATSL) # now they are factors again

# Print out summaries of the variables
summary(RATSL)


```


```{r}
library(ggplot2)

# Draw the plot of different groups
ggplot(RATSL, aes(x = Time, y = Weight, col = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, times = 2)) +
  facet_grid(. ~ Group, labeller = label_both) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) +
  scale_y_continuous(name = "Weight (grams)") +
  theme(legend.position = "none")


```


### The Golden Standardise


```{r}
library(dplyr)
library(tidyr)
# Standardise the variable Weight
RATSL <- RATSL %>%
  group_by(Time) %>%
  mutate(stdWeight = (Weight - mean(Weight))/sd(Weight)) %>%
  ungroup()

# Glimpse the data
glimpse(RATSL)

# Plot again with the standardised Weights
library(ggplot2)

ggplot(RATSL, aes(x = Time, y = stdWeight, col = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, times = 2)) +
  facet_grid(. ~ Group, labeller = label_both) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) +
  scale_y_continuous(name = "standardized Weight")



```



### Summary graphs


```{r}
# Number of subjects (per group):
n <- 16

library(dplyr)
library(tidyr)
# Summary data with mean and standard error of bprs by treatment and week 
RATSS <- RATSL %>%
  group_by(Group, Time) %>%
  summarise( mean = mean(Weight), se = sd(Weight)/sqrt(n) ) %>%
  ungroup()

# Glimpse the data
glimpse(RATSS)

# Plot the mean profiles
library(ggplot2)
ggplot(RATSS, aes(x = Time, y = mean, linetype = Group, col = Group, shape = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.8,0.4)) +
  scale_y_continuous(name = "mean(Weight) +/- se(Weight)")


```


### Find out the outlier


```{r}

library(dplyr)
library(tidyr)
# Create a summary data by Group and ID with mean as the summary variable
RATSL8S <- RATSL %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(Weight) ) %>%
  ungroup()

# Glimpse the data
glimpse(RATSL8S)

# Draw a boxplot of the mean versus Group
library(ggplot2)
ggplot(RATSL8S, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight), days 1-64")

# Create a new data by filtering the 3 outliers
RATSL8S1 <- RATSL8S %>% 
  filter(mean > 250) %>% 
  filter(mean < 550) %>% 
  filter(ID != 13)


ggplot(RATSL8S1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(Weight), days 1-64")



```


# ANOVA


```{r}
library(dplyr)
library(tidyr)

# Fit the linear model with the mean as the response 
fit <- lm(mean ~ Group, data = RATSL8S)

# Compute the analysis of variance table for the fitted model with anova()
anova(fit)


```


## Meet and Repeat: PART II


```{r}
# Read in the data set that was created
# Read the RATSL data
BPRSL <- read.table(file.path(".", "data", "BPRSL.txt"))

# Look at the (column) names of BPRS
names(BPRSL)

# Look at the structure of BPRSL
str(BPRSL) # ID and Group aren't factors anymore

# change ID and Groups back to factors
BPRSL$treatment <- factor(BPRSL$treatment)
BPRSL$subject <- factor(BPRSL$subject)

str(BPRSL) # now they are factors again

# Print out summaries of the variables
summary(BPRSL)


```


### Plot the data


```{r}

library(dplyr)
library(tidyr)

# Plot the BPRSL data
library(ggplot2)
ggplot(BPRSL, aes(x = week, y = bprs, linetype = treatment, color = treatment)) +
  geom_line(aes(group = interaction(subject, treatment))) +
  scale_x_continuous(name = "week") +
  scale_y_continuous(name = "bprs", limits = c(min(BPRSL$bprs), max(BPRSL$bprs))) +
  scale_color_manual(values = c("darkorchid2", "gold3")) +
  theme(legend.position = "top")

```


### Holding on to independence: The Linear model


```{r}
# create a regression model BPRSL_reg
BPRS_reg <- lm(bprs ~ week + treatment, data = BPRSL)

# print out a summary of the model
summary(BPRS_reg)


```


### The Random Intercept Model


```{r}
# access library lme4
library(lme4)

# Create a random intercept model
BPRS_ref <- lmer(bprs ~ week + treatment + (1 | subject), data = BPRSL, REML = FALSE)

# Print the summary of the model
summary(BPRS_ref)



```


### Random Intercept and Random Slope Model


```{r}
library(lme4)
BPRS_ref1 <- lmer(bprs ~ week + treatment + (week | subject), data = BPRSL, REML = FALSE)

# print a summary of the model
summary(BPRS_ref1)

# perform an ANOVA test on the two models
anova(BPRS_ref1, BPRS_ref)


```


### Random Intercept and Random Slope Model with interaction


```{r}

library(lme4)
BPRS_ref2 <- lmer(bprs ~ week*treatment + (week | subject), data = BPRSL, REML = FALSE)

# print a summary of the model
summary(BPRS_ref2)

# perform an ANOVA test on the two models
anova(BPRS_ref2, BPRS_ref1)

# Create a vector of the fitted values
Fitted <- fitted(BPRS_ref2)

library(dplyr)
library(tidyr)
# Create a new column fitted to RATSL
BPRSL <- BPRSL %>% mutate(Fitted = Fitted)

# plot the observed and mutated values
library(ggplot2)
ggplot(BPRSL, aes(x = week, y = bprs, linetype = treatment, color = treatment)) +
  geom_line(aes(group = interaction(subject, treatment))) +
  scale_x_continuous(name = "week") +
  scale_y_continuous(name = "observed bprs") +
  scale_color_manual(values = c("darkorchid2", "gold3")) +
  theme(legend.position = "top")

ggplot(BPRSL, aes(x = week, y = Fitted, linetype = treatment, color = treatment)) +
  geom_line(aes(group = interaction(subject, treatment))) +
  scale_x_continuous(name = "week") +
  scale_y_continuous(name = "fitted bprs") +
  scale_color_manual(values = c("darkorchid2", "gold3")) +
  theme(legend.position = "top")




```










